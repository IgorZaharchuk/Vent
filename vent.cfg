# Система управления термокамерой и вентиляцией
# v2.0

[temperature_sensor chamber]
sensor_type: MAX6675
sensor_pin: PA13
spi_software_sclk_pin: PC11
spi_software_mosi_pin: PE3
spi_software_miso_pin: PC10
min_temp: 0
max_temp: 85

[fan_generic circulation_fan]
pin: PC6
hardware_pwm: true
enable_pin: PC7
tachometer_pin: PA14
tachometer_poll_interval: 0.002
shutdown_speed: 0.0
kick_start_time: 1.0
off_below: 0.1
max_power: 1.0
cycle_time: 0.01

[gcode_macro _VENT_VAR]
description: внутренние переменные системы вентиляции
variable_chamber_target: 40.0
variable_ema_chamber_temp: 0.0
variable_control_mode: 0
variable_last_bed_state: 0
variable_current_servo_angle: -1
variable_awaiting_resume: 0
variable_extruder_heating: 0
variable_target_reached: 0
variable_wait_start_loop: -1
variable_wait_timeout: 3600.0
variable_bed_control: 0
variable_last_ema_temp: 0.0
variable_last_ext_fan_state: 0
variable_print_completed: 0
variable_bed_target_temp: 50.0
variable_bed_min_temp: 50.0
variable_bed_t_explicit: 0
variable_last_awaiting_resume: 0
variable_last_print_completed: 0
variable_last_bed_control: 0
variable_last_bed_target_temp: 50.0
variable_time_left_sec: 0.0
variable_error_code: 0
variable_last_time_for_rate: -1.0
variable_last_median_temp_for_rate: 0.0
variable_last_target_minutes: 0
variable_heating_estimate_valid: 0
variable_current_heat_rate_cpm: 0.0
variable_ema_heat_rate: 0.0
variable_equilibrium_est: 0.0
variable_loop_counter: 0
variable_raw_t0: 0.0
variable_raw_t1: 0.0
variable_raw_t2: 0.0
variable_initial_estimate_done: 0
variable_start_chamber_temp: 25.0
variable_current_median_temp: 25.0
variable_last_reported_target_minutes: -1
variable_last_debug_time_left_min: -1
variable_measurement_state: 0  # 0=Waiting, 1=Measuring, 2=Estimating, 3=Adapting
variable_measure_start_loop_counter: -1.0
variable_measure_start_chamber_temp: 0.0
variable_ema_filtered_rate: 0.0
variable_real_bed_temp: 0.0
gcode:
    {% if not params.RESET is defined %}
        { action_raise_error("макрос _VENT_VAR предназначен только для внутреннего использования") }
    {% endif %}
    {% set reset_list = (params.RESET | string).split(',') | map('trim') | map('int') | list %}

    # группа 1: логическое состояние нагрева
    {% if 1 in reset_list %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="print_completed" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="target_reached" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="initial_estimate_done" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="bed_min_temp" VALUE=50.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="bed_t_explicit" VALUE=0
    {% endif %}

    # группа 2: сброс прогноза нагрева
    {% if 2 in reset_list %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_time_for_rate" VALUE=-1.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_median_temp_for_rate" VALUE=0.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="heating_estimate_valid" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="ema_heat_rate" VALUE=0.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="current_heat_rate_cpm" VALUE=0.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_target_minutes" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_reported_target_minutes" VALUE=-1
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_debug_time_left_min" VALUE=-1
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="measurement_state" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="measure_start_loop_counter" VALUE=-1.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="measure_start_chamber_temp" VALUE=0.0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="ema_filtered_rate" VALUE=0.0
    {% endif %}

    # группа 3: сброс ошибок
    {% if 3 in reset_list %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="error_code" VALUE=0
    {% endif %}

    # группа 4: состояние паузы — НЕЛЬЗЯ сбрасывать при повторном VENT_AUTO
    {% if 4 in reset_list %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="awaiting_resume" VALUE=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="extruder_heating" VALUE=0
    {% endif %}

    # группа 5: сброс таймера ожидания
    {% if 5 in reset_list %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="wait_start_loop" VALUE=-1
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="time_left_sec" VALUE=0.0
    {% endif %}

[delayed_gcode vent_control_loop]
initial_duration: 0
gcode:
    {% set status = printer["gcode_macro _VENT_VAR"] %}
    {% set print_stats = printer.print_stats %}
    {% set current_print_state = print_stats.state %}
    {% set is_printing = (current_print_state == "printing") %}
    {% set skip_update = false %}
    {% set bed = printer.heater_bed %}
    {% set extruder = printer.extruder %}
    {% set chamber = printer["temperature_sensor chamber"] %}
    
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="real_bed_temp" VALUE={bed.temperature|default(0.0)|float}

    # проверка термопары
    {% set RAW_TEMP_INPUT = chamber.temperature|default(9999.0) %}
    {% if RAW_TEMP_INPUT >= 100.0 %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="error_code" VALUE=1
        VENT_STATUS
        VENT_OFF
        {% set skip_update = true %}
    {% endif %}

    # обработка отмены/ошибки
    {% set is_cancelled = (current_print_state in ["canceled", "cancelled"]) %}
    {% set is_error = (current_print_state == "error") %}
    {% if is_cancelled or is_error %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="error_code" VALUE={2 if is_cancelled else 3}
        VENT_STATUS
        VENT_OFF
        {% set skip_update = true %}
        _VENT_VAR RESET=4
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="print_completed" VALUE=0
    {% else %}
        {% if is_printing %}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="print_completed" VALUE=0
            _VENT_VAR RESET=4,5
        {% endif %}
        {% if current_print_state == "complete" and status.print_completed == 0 %}
            { action_respond_info("VENT: Печать завершена - управление столом заблокировано") }
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="print_completed" VALUE=1
            _VENT_VAR RESET=5
        {% endif %}
    {% endif %}

    # счетчик времени
    {% set new_loop_counter = (status.loop_counter + 1)|float %}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="loop_counter" VALUE={new_loop_counter}
    {% set elapsed_seconds = 0 %}
    {% if status.wait_start_loop >= 0 %}
        {% set elapsed_seconds = (new_loop_counter - status.wait_start_loop) * 10 %}
    {% endif %}

    # таймаут ожидания
    {% if status.wait_start_loop >= 0 %}
        {% set time_left = status.wait_timeout - elapsed_seconds %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="time_left_sec" VALUE={[time_left, 0]|max}
        {% if elapsed_seconds > status.wait_timeout %}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="error_code" VALUE=4
            VENT_STATUS
            {% if status.awaiting_resume == 1 %}
                CANCEL_PRINT
            {% endif %}
            VENT_OFF
            {% set skip_update = true %}
        {% endif %}
    {% endif %}

    {% if not skip_update %}
        {% set TARGET = status.chamber_target|default(40.0)|float %}
        
        # медианная фильтрация
        {% set t_now = RAW_TEMP_INPUT %}
        {% set t_prev = status.raw_t0|default(t_now) %}
        {% set t_prev2 = status.raw_t1|default(t_now) %}
        {% if t_prev < 5.0 %}
            {% set t_prev = t_now %}
        {% endif %}
        {% if t_prev2 < 5.0 %}
            {% set t_prev2 = t_now %}
        {% endif %}
        {% set sorted_temps = [t_now, t_prev, t_prev2] | sort %}
        {% set MEDIAN_TEMP = sorted_temps[1] %}
        
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="raw_t2" VALUE={status.raw_t1}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="raw_t1" VALUE={status.raw_t0}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="raw_t0" VALUE={t_now}
        
        # ema-сглаживание
        {% set ALPHA = 0.5 %}
        {% set prev_ema = status.ema_chamber_temp %}
        {% if prev_ema < 5.0 %}
            {% set prev_ema = MEDIAN_TEMP %}
        {% endif %}
        {% set CURRENT_TEMP = (ALPHA * MEDIAN_TEMP) + ((1 - ALPHA) * prev_ema) %}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="ema_chamber_temp" VALUE={CURRENT_TEMP}
        
        # гистерезис цели
        {% set HYSTERESIS_BED_ON = 3.0 %}
        {% set current_target_reached = status.target_reached %}
        {% if current_target_reached == 0 %}
            {% if CURRENT_TEMP >= TARGET %}
                SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="target_reached" VALUE=1
            {% endif %}
        {% else %}
            {% if CURRENT_TEMP < TARGET - HYSTERESIS_BED_ON %}
                SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="target_reached" VALUE=0
            {% endif %}
        {% endif %}
        
        # логика возобновления печати
        {% if status.awaiting_resume == 1 %}
            {% if status.target_reached == 1 and status.extruder_heating == 0 %}
                { action_respond_info("VENT: Камера готова - нагрев экструдера до 100°C") }
                SET_HEATER_TEMPERATURE HEATER=extruder TARGET=100
                SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="extruder_heating" VALUE=1
            {% elif status.extruder_heating == 1 and extruder.temperature|default(0) >= 100 %}
                { action_respond_info("VENT: Экструдер готов - возобновление печати") }
                _VENT_VAR RESET=4,5
                RESUME
            {% endif %}
        {% endif %}
        
        # разрешить управление столом только в режиме сушки или ожидания возобновления
        {% set in_vent_auto_context = (
            status.control_mode == 0 and
            not status.print_completed and
            (printer.print_stats.state == "standby" or status.awaiting_resume == 1)
        ) %}
        {% set current_allow_bed = 1 if in_vent_auto_context else 0 %}
        
        {% set needs_update = (
            (CURRENT_TEMP - status.last_ema_temp)|abs >= 0.5 or
            status.awaiting_resume != status.last_awaiting_resume or
            status.print_completed != status.last_print_completed or
            current_allow_bed != status.last_bed_control or
            status.bed_target_temp != status.last_bed_target_temp
        ) %}
        {% if needs_update %}
            _VENT_SET_MODE CONTROL_MODE=0 ALLOW_BED={current_allow_bed} CURRENT_TEMP={CURRENT_TEMP} TARGET_REACHED={status.target_reached}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_ema_temp" VALUE={CURRENT_TEMP}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_awaiting_resume" VALUE={status.awaiting_resume}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_print_completed" VALUE={status.print_completed}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_bed_control" VALUE={current_allow_bed}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_bed_target_temp" VALUE={status.bed_target_temp}
        {% endif %}
        
        # расчёт скорости нагрева
        {% set can_estimate = (
            status.wait_timeout > 0 and
            status.control_mode == 0 and
            current_allow_bed == 1) %}
        
        {% if can_estimate %}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="current_median_temp" VALUE={MEDIAN_TEMP}
            _VENT_HEATING_ESTIMATE
        {% else %}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="heating_estimate_valid" VALUE=0
        {% endif %}
 
        UPDATE_DELAYED_GCODE ID=vent_control_loop DURATION=10.0
    {% endif %}

[delayed_gcode vent_startup]
initial_duration: 2.0
gcode:
    {% set temp = printer["temperature_sensor chamber"].temperature|default(25.0) %}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="ema_chamber_temp" VALUE={temp}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_ema_temp" VALUE={temp}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="loop_counter" VALUE=0
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="current_servo_angle" VALUE=-1
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="raw_t0" VALUE={temp}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="raw_t1" VALUE={temp}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="raw_t2" VALUE={temp}
    _VENT_VAR RESET=1,2,3,4,5
    VENT_OFF
    { action_respond_info("VENT: Система запущена. Температура: %.1f°C" % temp) }

[gcode_macro _VENT_SET_MODE]
description: управление - только по ema-температуре
gcode:
    {% set p = params %}
    {% set status = printer["gcode_macro _VENT_VAR"] %}
    {% set control_mode = p.CONTROL_MODE|default(0)|int %}
    {% set allow_bed = p.ALLOW_BED|default(0)|int %}
    {% set CURRENT_TEMP = p.CURRENT_TEMP|default(printer["gcode_macro _VENT_VAR"].ema_chamber_temp|default(25.0))|float %}
    {% set target_reached = p.TARGET_REACHED|default(0)|int %}
    {% set TARGET = status.chamber_target|float %}

    # Сброс состояния при смене режима (все группы, кроме 4 при повторном VENT_AUTO)
    {% if control_mode != 0 %}
        _VENT_VAR RESET=1,2,3,4,5
    {% endif %}

    # Параметры управления
    {% set DAMPER_OPEN_THRESHOLD = 1.0 %}
    {% set OVERTEMP_THRESHOLD = 10.0 %}
    {% set CIRCULATION_MIN = 0.5 %}
    {% set HYSTERESIS_BED_ON = 3.0 %}
    {% set OVERTEMP_ON = 10.0 %}
    {% set OVERTEMP_OFF = 5.0 %}
    {% set target_angle = 95 %}
    {% set calc_speed = CIRCULATION_MIN %}
    {% set calc_ext_speed = 0.0 %}

    # Логика скорости циркуляции
    {% set in_heating_mode = (control_mode == 0 and allow_bed == 1 and target_reached == 0) %}
    {% if in_heating_mode %}
        {% set calc_speed = 1.0 %}
    {% else %}
        {% set temp_diff = CURRENT_TEMP - TARGET %}
        {% if temp_diff <= -HYSTERESIS_BED_ON %}
            {% set calc_speed = 1.0 %}
        {% elif temp_diff < 0 %}
            {% set normalized = (CURRENT_TEMP - (TARGET - HYSTERESIS_BED_ON)) / HYSTERESIS_BED_ON %}
            {% set calc_speed = 1.0 - (normalized * (1.0 - CIRCULATION_MIN)) %}
        {% else %}
            {% set ratio = temp_diff / OVERTEMP_THRESHOLD %}
            {% set calc_speed = CIRCULATION_MIN + (ratio * (1.0 - CIRCULATION_MIN)) %}
            {% set calc_speed = [calc_speed, 1.0]|min %}
        {% endif %}
    {% endif %}

    # Управление заслонкой в автоматическом режиме
    {% if control_mode == 0 %}
        {% if CURRENT_TEMP <= TARGET %}
            {% set target_angle = 95 %}
        {% elif CURRENT_TEMP > TARGET + DAMPER_OPEN_THRESHOLD %}
            {% set target_angle = 175 %}
        {% else %}
            {% set target_angle = status.current_servo_angle|default(95) %}
        {% endif %}
    {% endif %}

    # Управление внешним вентилятором
    {% set last_ext = status.last_ext_fan_state|default(0) %}
    {% set new_ext = 0 %}
    {% if control_mode == 2 %}
        {% set new_ext = 1 %}
    {% elif control_mode == 0 %}
        {% if last_ext == 1 %}
            {% if CURRENT_TEMP >= TARGET + OVERTEMP_OFF %}
                {% set new_ext = 1 %}
            {% endif %}
        {% else %}
            {% if CURRENT_TEMP >= TARGET + OVERTEMP_ON %}
                {% set new_ext = 1 %}
            {% endif %}
        {% endif %}
    {% endif %}
    {% set calc_ext_speed = new_ext * 1.0 %}

    # Ручные режимы
    {% if control_mode == 1 %}
        {% set target_angle = 95 %}
        {% set calc_speed = 1.0 %}
        {% set calc_ext_speed = 0.0 %}
    {% elif control_mode == 2 %}
        {% set target_angle = 175 %}
        {% set calc_speed = 1.0 %}
        {% set calc_ext_speed = 1.0 %}
    {% elif control_mode == 3 %}
        {% set calc_speed = 0.0 %}
        {% set calc_ext_speed = 0.0 %}
        {% set target_angle = 95 %}
    {% endif %}

    # Управление столом
    {% if allow_bed == 1 %}
        # AUTO-режим: активное управление
        {% if target_reached == 0 %}
            SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={status.bed_target_temp|default(50)}
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_bed_state" VALUE=1
        {% else %}
            SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
            SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_bed_state" VALUE=0
        {% endif %}
    {% elif control_mode == 3 and status.last_bed_state == 1 %}
        # VENT_OFF: выключаем ТОЛЬКО если вентиляция его включала
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_bed_state" VALUE=0
    {% endif %}

    # Управление заслонкой
    {% if target_angle != status.current_servo_angle %}
        SET_SERVO SERVO=my_servo ANGLE={target_angle}
        SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="current_servo_angle" VALUE={target_angle}
        UPDATE_DELAYED_GCODE ID=vent_servo_off_timer DURATION=1.0
    {% endif %}

    # Управление вентиляторами
    _SET_FAN_SPEED FAN=circulation_fan SPEED={calc_speed}
    {% if 'fan_generic external' in printer %}
        _SET_FAN_SPEED FAN=external SPEED={calc_ext_speed}
    {% endif %}

    # Обновление состояния
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="control_mode" VALUE={control_mode}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="bed_control" VALUE={allow_bed}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="last_ext_fan_state" VALUE={new_ext}

[delayed_gcode vent_servo_off_timer]
initial_duration: 0
gcode:
    SET_SERVO SERVO=my_servo WIDTH=0

[gcode_macro VENT_AUTO]
description: Целевая t°C камеры (20–60°C), Таймаут(10–600 минут), t°C стола — минимум (по умолчанию TEMP+10, макс 120°C)
gcode:
    {% set current_status = printer["gcode_macro _VENT_VAR"] %}
    {% set TARGET_TEMP = params.TEMP|default(40)|float %}
    {% set TIMEOUT_MINUTES = params.WAIT|default(60)|float %}

    {% set TARGET_TEMP = [[TARGET_TEMP, 20]|max, 60]|min %}
    {% set TIMEOUT_MINUTES = [[TIMEOUT_MINUTES, 10]|max, 600]|min %}

    # Определяем BED_MIN: явно заданное или по умолчанию (TEMP + 10)
    {% if "BED_T" in params %}
        {% set BED_CANDIDATE = params.BED_T|float %}
        {% set BED_T_EXPLICIT = 1 %}
    {% else %}
        {% set BED_CANDIDATE = TARGET_TEMP + 10 %}
        {% set BED_T_EXPLICIT = 0 %}
    {% endif %}
    {% set BED_MIN = [BED_CANDIDATE, TARGET_TEMP + 10]|max %}
    {% set BED_MIN = [BED_MIN, 120.0]|min %}

    {% set start_temp = printer["temperature_sensor chamber"].temperature|default(25.0) %}

    # Условный сброс
    {% if current_status.awaiting_resume == 0 %}
        _VENT_VAR RESET=1,2,3,4,5
    {% else %}
        _VENT_VAR RESET=1,2,3,5  # ← группа 4 НЕ сбрасывается!
    {% endif %}

    # Обновление параметров
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="chamber_target" VALUE={TARGET_TEMP}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="wait_timeout" VALUE={TIMEOUT_MINUTES * 60.0}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="bed_min_temp" VALUE={BED_MIN}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="bed_target_temp" VALUE={BED_MIN}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="bed_t_explicit" VALUE={BED_T_EXPLICIT}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="start_chamber_temp" VALUE={start_temp}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="wait_start_loop" VALUE={printer["gcode_macro _VENT_VAR"].loop_counter}
    
    {% set RAW_TEMP_AT_START = printer["temperature_sensor chamber"].temperature|default(25.0) %}
    {% if params.TEMP|default(40)|float > RAW_TEMP_AT_START %}
        # Первый расчёт — сразу при запуске (только если цель выше текущей температуры)
        _VENT_HEATING_ESTIMATE
    {% endif %}

    _VENT_SET_MODE CONTROL_MODE=0 ALLOW_BED=1 CURRENT_TEMP={start_temp} TARGET_REACHED=0
    UPDATE_DELAYED_GCODE ID=vent_control_loop DURATION=10.0

    # Установка печати на паузу — только если ещё не в режиме ожидания
    {% if current_status.awaiting_resume == 0 %}
        {% set is_printing = (printer.print_stats.state == "printing") %}
        {% set bed_cold = (printer.heater_bed.target == 0) %}
        {% set is_safe_to_pause = is_printing and bed_cold %}
        {% if is_safe_to_pause %}
            {% set ema_temp = printer["gcode_macro _VENT_VAR"].ema_chamber_temp %}
            {% if ema_temp >= TARGET_TEMP %}
                { action_respond_info("VENT: Камера уже прогрета - печать продолжается") }
            {% else %}
                { action_respond_info("VENT: Печать на паузе, ожидание прогрева камеры") }
                SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="awaiting_resume" VALUE=1
                PAUSE
            {% endif %}
        {% endif %}
    {% endif %}

[gcode_macro VENT_INTERNAL]
description: Ручной внутренний режим
gcode:
    _VENT_SET_MODE CONTROL_MODE=1 ALLOW_BED=0
    UPDATE_DELAYED_GCODE ID=vent_control_loop DURATION=0
    { action_respond_info("Ручная Внутренняя вентиляция") }

[gcode_macro VENT_EXTERNAL]
description: Ручной внешний режим
gcode:
    _VENT_SET_MODE CONTROL_MODE=2 ALLOW_BED=0
    UPDATE_DELAYED_GCODE ID=vent_control_loop DURATION=0
    { action_respond_info("Ручная Внешняя вентиляция") }

[gcode_macro VENT_OFF]
description: Выключение всей системы вентиляции
gcode:
    {% set current_temp = printer["temperature_sensor chamber"].temperature|default(25.0) %}
    SET_GCODE_VARIABLE MACRO="_VENT_VAR" VARIABLE="ema_chamber_temp" VALUE={current_temp}
    {% set current_mode = printer["gcode_macro _VENT_VAR"].control_mode|default(0)|int %}
    {% if current_mode == 0 %}
        _VENT_VAR RESET=5
        _VENT_HEATING_ESTIMATE
    {% endif %}
    _VENT_SET_MODE CONTROL_MODE=3 ALLOW_BED=0
    UPDATE_DELAYED_GCODE ID=vent_control_loop DURATION=0
    { action_respond_info("Вентиляция Выкл") }

[gcode_macro _VENT_HEATING_ESTIMATE]
description: Вызов внешнего скрипта vent_calc.py для выполнения всех расчётов
gcode:
    RUN_SHELL_COMMAND CMD=vent_run_calc

[gcode_shell_command vent_run_calc]
command: /bin/sh /opt/config/mod_data/plugins/vent/vent_wrapper.sh
timeout: 2.0

[gcode_macro VENT_STATUS]
description: Состояние системы
gcode:
    {% set status = printer["gcode_macro _VENT_VAR"] %}
    {% set print_stats = printer.print_stats %}
    {% set CURRENT_TEMP = status.ema_chamber_temp|default(0.0) %}
    {% set TARGET = (status.chamber_target|default(40.0)|float) %}
    {% set control_mode = status.control_mode|default(0) %}
    {% set circulation_speed = printer["fan_generic circulation_fan"].speed|default(0) %}
    {% set servo_angle = status.current_servo_angle|default(95) %}
    {% set mode_str = (
        "Ручной " if control_mode != 0 else
        "Полное охлаждение " if (circulation_speed >= 0.99 and servo_angle == 175) else
        "Охлаждение " if (circulation_speed >= 0.5 and servo_angle == 175) else
        "Нагрев " if (printer.heater_bed.target > 0 and status.bed_control == 1) else
        "Удержание "
    ) %}
    {% set control_mode_names = ["Авто ", "Ручн.Внутр. ", "Ручн.Внеш ", "Выкл "] %}
    {% set bed_state_str = "Вкл " if printer.heater_bed.target > 0 else "Выкл " %}
    {% set is_printing = (print_stats.state == "printing") %}
    {% set heaters_active = is_printing and (printer.heater_bed.target > 0 or printer.extruder.target > 0) %}
    {% set control_str = "Вентиляция " if (status.control_mode == 0 and not heaters_active and status.print_completed == 0) else "Стандарт " %}
    {% set temp_display = "%.1f°C (EMA: %.2f°C)"|format(printer["temperature_sensor chamber"].temperature, CURRENT_TEMP) %}
    RESPOND TYPE=command MSG="action:prompt_begin Статус вентиляции v1.10 "

    #Определение сообщений об ошибках
    {% set equilibrium_val = status.equilibrium_est|default(0)|round(1) %}
    {% set error_msg_6 = "❌ Цель физически недостижима (макс. температура ~ {:.1f}°C при 120°C стола)".format(equilibrium_val) %}
    {% set error_msgs = {
        1: "❌ Неисправность термопары (T >= 100°C)",
        2: "❌ Печать отменена — вентиляция остановлена",
        3: "❌ КРИТИЧЕСКАЯ ОШИБКА принтера",
        4: "❌ ТАЙМАУТ нагрева",
        5: "⚠️ Прогноз: камера не достигнет цели до истечения таймаута",
        6: error_msg_6
    } %}
    {% set code = status.error_code|int %}
    {% if code > 0 and code in error_msgs %}
        RESPOND TYPE=command MSG="action:prompt_text {error_msgs[code]}"
    {% endif %}
    RESPOND TYPE=command MSG="action:prompt_text Режим: {control_mode_names[control_mode]} — {mode_str}"
    RESPOND TYPE=command MSG="action:prompt_text Стол: {bed_state_str}, Управление: {control_str}"
    RESPOND TYPE=command MSG="action:prompt_text Температура: {temp_display}"
    RESPOND TYPE=command MSG="action:prompt_text Цель: Камера - {TARGET}°C, Стол - {status.bed_target_temp}°C"

    {% if status.control_mode == 0 %}
        {% set time_left_sec = status.time_left_sec|default(0) %}
        {% if time_left_sec > 0 %}
            {% set timeout_minutes = (time_left_sec / 60)|int %}
            RESPOND TYPE=command MSG="action:prompt_text Таймаут: {timeout_minutes} мин"
            {% if status.heating_estimate_valid == 1 %}
                {% set heat_rate_str = "%.1f"|format(status.current_heat_rate_cpm) %}
                {% set target_min = status.last_target_minutes|default(0) %}
                {% if target_min > timeout_minutes %}
                    RESPOND TYPE=command MSG="action:prompt_text Прогноз: {heat_rate_str} °C/мин, до цели ~{target_min} мин ⚠️"
                {% else %}
                    RESPOND TYPE=command MSG="action:prompt_text Прогноз: {heat_rate_str} °C/мин, до цели ~{target_min} мин"
                {% endif %}
            {% endif %}
        {% else %}
            RESPOND TYPE=command MSG="action:prompt_text Таймаут истек"
        {% endif %}
    {% endif %}

    RESPOND TYPE=command MSG="action:prompt_text Состояние печати: {print_stats.state}"
    {% if status.awaiting_resume|default(0) == 1 %}
        RESPOND TYPE=command MSG="action:prompt_text Ожидание нагрева"
    {% endif %}
    {% if 'fan_generic external' in printer and printer["fan_generic external"].speed > 0.01 %}
        {% set ext_speed = "%.0f"|format(printer["fan_generic external"].speed * 100) %}
        RESPOND TYPE=command MSG="action:prompt_text Внешний вентилятор: {ext_speed}%"
    {% endif %}
    {% set circ_speed = "%.0f"|format(printer["fan_generic circulation_fan"].speed * 100) %}
    {% set circ_rpm = "%.0f"|format(printer["fan_generic circulation_fan"].rpm|default(0)) %}
    RESPOND TYPE=command MSG="action:prompt_text Циркуляция: {circ_speed}% ({circ_rpm} RPM)"
    RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
    RESPOND TYPE=command MSG="action:prompt_show"